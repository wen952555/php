<!-- 注册/登录/显示积分模块 -->
<div id="auth" style="margin:8px 0;">
  <div id="loginForm">
    <input id="phone" placeholder="手机号">
    <input id="password" type="password" placeholder="密码">
    <button onclick="login()">登录</button>
    <button onclick="showRegister()">注册</button>
  </div>
  <div id="registerForm" style="display:none">
    <input id="regPhone" placeholder="手机号">
    <input id="regNickname" placeholder="昵称">
    <input id="regPassword" type="password" placeholder="密码">
    <button onclick="register()">注册</button>
    <button onclick="showLogin()">返回登录</button>
  </div>
  <div id="userInfo" style="display:none">
    <span id="nick"></span> <span id="myscore"></span>
    <button onclick="logout()">退出</button>
    <button onclick="showHistory()">积分流水</button>
    <span id="adminPanel" style="display:none">
      <button onclick="showAdminAdd()">管理员加分</button>
      <button onclick="showAdminSub()">管理员减分</button>
    </span>
  </div>
</div>
<!-- 游戏主页面内容继续... -->
<!-- 管理员加分弹窗 -->
<div id="adminAddPanel" style="display:none">
  <input id="addPhone" placeholder="手机号">
  <input id="addValue" placeholder="加分数">
  <button onclick="adminAdd()">加分</button>
  <button onclick="hideAdminAdd()">关闭</button>
</div>
<!-- 管理员减分弹窗 -->
<div id="adminSubPanel" style="display:none">
  <input id="subPhone" placeholder="手机号">
  <input id="subValue" placeholder="减分数">
  <button onclick="adminSub()">减分</button>
  <button onclick="hideAdminSub()">关闭</button>
</div>
<!-- 积分流水弹窗 -->
<div id="historyPanel" style="display:none;">
  <div id="historyList"></div>
  <button onclick="hideHistory()">关闭</button>
</div>
<script>
function showLogin() {
  document.getElementById('loginForm').style.display = '';
  document.getElementById('registerForm').style.display = 'none';
}
function showRegister() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('registerForm').style.display = '';
}
function login() {
  fetch('login.php', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({ phone: phone.value, password: password.value })
  }).then(res=>res.json()).then(r=>{
    if(r.ok) {
      showUser();
    } else alert(r.error);
  });
}
function register() {
  fetch('register.php', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ phone: regPhone.value, nickname: regNickname.value, password: regPassword.value })
  }).then(res=>res.json()).then(r=>{
    if(r.ok) { alert('注册成功'); showLogin(); }
    else alert(r.error);
  });
}
function showUser() {
  fetch('userinfo.php', { credentials:'include' }).then(res=>res.json()).then(r=>{
    if(r.phone) {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('userInfo').style.display = '';
      document.getElementById('nick').innerText = r.nickname;
      document.getElementById('myscore').innerText = ' 积分:'+r.score;
      document.getElementById('adminPanel').style.display = r.is_admin ? '' : 'none';
    } else { showLogin(); }
  });
}
function logout() {
  fetch('logout.php').then(()=>showLogin());
}
function showAdminAdd() {
  document.getElementById('adminAddPanel').style.display = '';
}
function hideAdminAdd() {
  document.getElementById('adminAddPanel').style.display = 'none';
}
function adminAdd() {
  fetch('score_add.php', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({ phone: addPhone.value, value: addValue.value })
  }).then(res=>res.json()).then(r=>{
    if(r.ok) alert('加分成功，新积分：'+r.newscore);
    else alert(r.error);
    hideAdminAdd();
  });
}
function showAdminSub() {
  document.getElementById('adminSubPanel').style.display = '';
}
function hideAdminSub() {
  document.getElementById('adminSubPanel').style.display = 'none';
}
function adminSub() {
  fetch('score_sub.php', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({ phone: subPhone.value, value: subValue.value })
  }).then(res=>res.json()).then(r=>{
    if(r.ok) alert('减分成功，新积分：'+r.newscore);
    else alert(r.error);
    hideAdminSub();
  });
}
function showHistory() {
  fetch('score_history.php', { credentials:'include' }).then(res=>res.json()).then(list=>{
    let html = '<table><tr><th>变化</th><th>后积分</th><th>类型</th><th>备注</th><th>时间</th></tr>';
    list.forEach(r=>{
      html += `<tr><td>${r.change_val}</td><td>${r.after_val}</td><td>${r.change_type}</td><td>${r.remark}</td><td>${r.create_time}</td></tr>`;
    });
    html += '</table>';
    document.getElementById('historyList').innerHTML = html;
    document.getElementById('historyPanel').style.display = '';
  });
}
function hideHistory() {
  document.getElementById('historyPanel').style.display = 'none';
}
showUser();
</script>
